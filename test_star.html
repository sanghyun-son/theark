<!DOCTYPE html>
<html>

<head>
    <title>Star Test</title>
    <style>
        .paper-item {
            border: 1px solid #ccc;
            margin: 10px;
            padding: 10px;
        }

        .star-button {
            font-size: 20px;
            cursor: pointer;
            border: none;
            background: none;
            padding: 5px;
        }

        .starred {
            color: gold;
        }

        .paper-id {
            color: #666;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <h1>Star Test</h1>
    <div id="papers"></div>
    <div id="debug"></div>

    <script>
        // Mock UIService for testing
        class UIService {
            constructor() {
                this.papers = [
                    {
                        paper_id: 1,
                        title: "Test Paper 1",
                        is_starred: false
                    }
                ];
            }

            createStarButton(paper) {
                const starButton = document.createElement('button');
                starButton.className = 'star-button';

                // Set initial state based on paper data
                const isStarred = paper.is_starred || false;
                starButton.textContent = isStarred ? '⭐' : '☆';
                starButton.title = isStarred ? 'Remove from favorites' : 'Add to favorites';

                if (isStarred) {
                    starButton.classList.add('starred');
                }

                // Add click handler
                starButton.onclick = (e) => {
                    e.stopPropagation(); // Prevent triggering other click events
                    this.toggleStar(paper, starButton);
                };

                return starButton;
            }

            async toggleStar(paper, starButton) {
                const isCurrentlyStarred = starButton.classList.contains('starred');
                const newStarredState = !isCurrentlyStarred;

                console.log('toggleStar called:', {
                    paperId: paper.paper_id,
                    isCurrentlyStarred,
                    newStarredState,
                    buttonText: starButton.textContent,
                    buttonClasses: starButton.className
                });

                try {
                    if (newStarredState) {
                        console.log('Adding star for paper:', paper.paper_id);
                        await this.addStar(paper.paper_id);
                    } else {
                        console.log('Removing star for paper:', paper.paper_id);
                        await this.removeStar(paper.paper_id);
                    }

                    console.log('API call successful, updating button');

                    // Update the specific button that was clicked
                    this.updateStarButton(starButton, newStarredState);

                    // Update all other star buttons for this paper
                    this.updateAllStarButtons(paper.paper_id, newStarredState);

                    console.log('Star toggle completed successfully');
                } catch (error) {
                    console.error('Failed to toggle star:', error);
                    // Revert to original state on error
                    this.updateStarButton(starButton, isCurrentlyStarred);
                }
            }

            updateAllStarButtons(paperId, isStarred) {
                console.log('updateAllStarButtons called:', { paperId, isStarred });

                // Update all star buttons for this paper in the paper list
                const paperElements = document.querySelectorAll('.paper-item');
                console.log('Found paper elements:', paperElements.length);

                let updatedCount = 0;
                for (const paperElement of paperElements) {
                    const idSpan = paperElement.querySelector('.paper-id');
                    if (idSpan && idSpan.textContent === `[${paperId}]`) {
                        const starButton = paperElement.querySelector('.star-button');
                        if (starButton) {
                            console.log('Updating paper list star button for paper:', paperId);
                            this.updateStarButton(starButton, isStarred);
                            updatedCount++;
                        }
                    }
                }

                console.log('updateAllStarButtons completed. Updated buttons:', updatedCount);
            }

            updateStarButton(starButton, isStarred) {
                console.log('updateStarButton called:', {
                    isStarred,
                    oldText: starButton.textContent,
                    oldClasses: starButton.className
                });

                starButton.textContent = isStarred ? '⭐' : '☆';

                if (isStarred) {
                    starButton.classList.add('starred');
                } else {
                    starButton.classList.remove('starred');
                }

                starButton.title = isStarred ? 'Remove from favorites' : 'Add to favorites';

                console.log('updateStarButton completed:', {
                    newText: starButton.textContent,
                    newClasses: starButton.className
                });
            }

            async addStar(paperId) {
                const response = await fetch(`/v1/papers/${paperId}/star`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ note: null }),
                });

                if (!response.ok) {
                    throw new Error('Failed to add star');
                }

                return await response.json();
            }

            async removeStar(paperId) {
                const response = await fetch(`/v1/papers/${paperId}/star`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to remove star');
                }

                return await response.json();
            }
        }

        // Initialize UI
        const uiService = new UIService();
        const papersContainer = document.getElementById('papers');

        uiService.papers.forEach(paper => {
            const paperElement = document.createElement('div');
            paperElement.className = 'paper-item';

            const title = document.createElement('div');
            title.innerHTML = `<span class="paper-title-text">${paper.title}</span> <span class="paper-id">[${paper.paper_id}]</span>`;

            const starButton = uiService.createStarButton(paper);

            paperElement.appendChild(title);
            paperElement.appendChild(starButton);
            papersContainer.appendChild(paperElement);
        });

        console.log('Test page loaded. Click the star button to test.');
    </script>
</body>

</html>